"use strict";var __awaiter=this&&this.__awaiter||function(t,e,r,n){function o(t){return t instanceof r?t:new r((function(e){e(t)}))}return new(r||(r=Promise))((function(r,i){function a(t){try{u(n.next(t))}catch(t){i(t)}}function s(t){try{u(n["throw"](t))}catch(t){i(t)}}function u(t){t.done?r(t.value):o(t.value).then(a,s)}u((n=n.apply(t,e||[])).next())}))};var __generator=this&&this.__generator||function(t,e){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:s(0),throw:s(1),return:s(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function s(t){return function(e){return u([t,e])}}function u(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=e.call(t,r)}catch(t){a=[6,t];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var __read=this&&this.__read||function(t,e){var r=typeof Symbol==="function"&&t[Symbol.iterator];if(!r)return t;var n=r.call(t),o,i=[],a;try{while((e===void 0||e-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(t){a={error:t}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var __spread=this&&this.__spread||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(__read(arguments[e]));return t};var __values=this&&this.__values||function(t){var e=typeof Symbol==="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length==="number")return{next:function(){if(t&&n>=t.length)t=void 0;return{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};var random=function(t){if(t===void 0){t=100}return Math.round(Math.random()*t)};var average=function(t){return t.reduce((function(t,e){return t+e}),0)/t.length};var median=function(t){var e=t.length/2|0;var r=t.slice().sort((function(t,e){return t<e?-1:e<t?1:0}));return r.length%2?r[e]:(r[e-1]+r[e])/2};var now=function(){return(new Date).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"numeric"}).replace(/\D/g,"")};var QUERY_NAME_MAP={".body":"身体―― Body",".nose":"鼻―― Nose",".fang .left":"左のキバ―― Left Fang",".fang .right":"右のキバ―― Right Fang",".eye .left":"左目―― Left Eye",".eye .right":"右目―― Right Eye"};function assertIsDefined(t){if(t==null){alert("レンダリングエラー: ページを再読込してください。");throw new Error("Expected 'val' to be defined, but received "+t)}}var Entity=function(){function t(t){this.animation=false;this.uniqQuery=t;this.name=t in QUERY_NAME_MAP?QUERY_NAME_MAP[t]:"";var e=document.querySelector(t);assertIsDefined(e);this.element=e}Object.defineProperty(t.prototype,"searchParams",{get:function(){var e=this;var r=new URLSearchParams;t.RESTORABLE_ATTRIBUTES.map((function(t){return[t,e.element.style.getPropertyValue(t)]})).forEach((function(t){var n=__read(t,2),o=n[0],i=n[1];return i&&r.append(e.uniqQuery+":"+o,i)}));return r},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"value",{get:function(){var t=function(t){return(t||"").split(/[^0-9^\\.]/).filter(Boolean).map(Number)};var e=__read(t(this.element.style.getPropertyValue("transform")),4),r=e[0],n=e[1],o=e[2],i=e[3];var a=__read(t(this.element.style.getPropertyValue("transform-origin")),2),s=a[0],u=a[1];return{x:r,y:n,scale:o,rotate:i,originX:s,originY:u}},enumerable:false,configurable:true});t.prototype.removeClass=function(){var t;var e=[];for(var r=0;r<arguments.length;r++){e[r]=arguments[r]}(t=this.element.classList).remove.apply(t,__spread(e))};t.prototype.addClass=function(){var t;var e=[];for(var r=0;r<arguments.length;r++){e[r]=arguments[r]}(t=this.element.classList).add.apply(t,__spread(e))};t.prototype.updateStyle=function(t,e){this.element.style.setProperty(t,e)};t.prototype.reset=function(){this.updateStyle("transform","translate(0px, 0px) scale(1) rotate(0deg)");this.updateStyle("transform-origin","50px 40px")};t.prototype.restore=function(){var e=this;var r=Object.fromEntries(new URLSearchParams(location.search));t.RESTORABLE_ATTRIBUTES.forEach((function(t){var n=r[e.uniqQuery+":"+t];if(n){e.updateStyle(t,n)}if(!location.search.includes("%2C")){e.element.setAttribute(t,n)}}))};t.RESTORABLE_ATTRIBUTES=["stroke","transform","transform-origin"];return t}();var Service=function(){function t(){this.hue=random();this.world=new Entity(".world");this.topText=new Entity(".top .text");this.buttons=new Entity(".buttons");this.saveImageButton=new Entity(".bottom .left.button");this.tweetButton=new Entity(".bottom .center.button");this.resetButton=new Entity(".bottom .right.button");this.animEntities=Object.keys(QUERY_NAME_MAP).map((function(t){return new Entity(t)}));this.params=new URLSearchParams(location.href);new Control(this);if(this.params.get("hue")!=null){this.restore()}if(this.params.get("download")!=null){this.downloadImage()}}Object.defineProperty(t.prototype,"bgColor",{get:function(){return"hsl("+this.hue+", 100%, 70%)"},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"accentColor",{get:function(){return"hsl("+(this.hue-90)%360+", 100%, 40%)"},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"resultURL",{get:function(){var t=new URLSearchParams;this.animEntities.forEach((function(e){return __spread(e.searchParams).forEach((function(e){var r=__read(e,2),n=r[0],o=r[1];return t.append(n,o)}))}));t.append("hue",String(this.hue));var e=location.href.replace(/(?!.*\/).*/,"");return e+"?"+t},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"score",{get:function(){var t=this.animEntities.reduce((function(t,e){var r=e.value;return{x:__spread(t.x,[r.x]),y:__spread(t.y,[r.y]),scale:__spread(t.scale,[r.scale]),rotate:__spread(t.rotate,[r.rotate]),originX:__spread(t.originX,[r.originX])}}),{x:[],y:[],scale:[],rotate:[],originX:[]});var e=function(t,e,r,n){if(n===void 0){n=false}var o=function(t,e,r,n,o){if(o===void 0){o=false}var i=e-t;var a=Math.abs(r-n%e*(o?2:1));return 100-a/i*100};return average(t.map((function(i){return o(e,r,median(t),i,n)})))};var r=[e(t.x,-64,64),e(t.y,-64,64),e(t.scale,.5,5.5),e(t.rotate,0,180,true),e(t.originX,45,55)];return Math.round(average(r)*10)/10},enumerable:false,configurable:true});t.prototype.downloadImage=function(){this.restore();this.buttons.addClass("hidden");svg2png(this.world.element).then((function(t){Object.assign(document.createElement("a"),{href:t,download:"akaino-warai_"+now()+".png"}).click();close()}))};t.prototype.openDownloadWindow=function(){open(this.resultURL+"&download=")};t.prototype.tweet=function(){var t=encodeURIComponent(this.resultURL);var e=this.score;var r=e<6?"キミは伝説の低級戦士……":e<30?"もうなんだかよくわからない！":e<50?"こんな朱猪になっちゃった！":e<70?"まあまあの出来！":e<90?"イイ線いってる！":e<95?"ミラクルショット！あと一歩！":"こんな完璧な朱猪ってある？？？";var n=encodeURIComponent(e+"点！ "+r+" 朱猪わらいで朱猪を完成させよう！");var o=encodeURIComponent("朱猪わらい");var i="//twitter.com/intent/tweet?text="+n+"&url="+t+"&hashtags="+o;open(i,"_blank","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width=710,height=400")};t.prototype.reset=function(){this.hue=random(360);this.animEntities.forEach((function(t){return t.reset()}));new Control(this)};t.prototype.restore=function(){this.hue=Number(this.params.get("hue"));this.animEntities.forEach((function(t){return t.restore()}));this.world.element.style.setProperty("background-color",this.bgColor);this.topText.updateStyle("stroke",this.accentColor);this.finish();this.updateTopText()};t.prototype.finish=function(){var t=this;this.world.element.onclick=this.world.element.onkeyup=null;this.world.addClass("loading");setTimeout((function(){t.buttons.removeClass("hidden");t.updateTopText("Score: "+t.score)}),500)};t.prototype.updateTopText=function(t){if(t===void 0){t=""}this.topText.element.innerHTML=t};return t}();var Control=function(){function t(t){this.service=t;this.currentEntity=null;this.service=t;this.start()}t.prototype.saveImageButtonClick=function(t){t.stopPropagation();this.service.openDownloadWindow()};t.prototype.tweetButtonClick=function(t){t.stopPropagation();this.service.tweet()};t.prototype.resetButtonClick=function(t){t.stopPropagation();this.service.reset()};t.prototype.nextStep=function(){var t=this;if(this.currentEntity==null){this.service.animEntities.forEach((function(e){return t.animate(e)}));this.currentEntity=this.service.animEntities[0]}else{this.currentEntity.updateStyle("stroke",null);this.currentEntity.animation=false;this.currentEntity=this.service.animEntities[this.service.animEntities.indexOf(this.currentEntity)+1]}if(this.currentEntity){this.service.updateTopText(this.currentEntity.name);this.currentEntity.updateStyle("stroke",this.service.accentColor)}else{this.service.finish()}};t.prototype.start=function(){var t=this;this.service.world.element.focus();this.service.world.removeClass("loading");this.service.updateTopText("クリックすると始まるよ！―― Click to Start!");this.service.world.element.style.setProperty("background-color",this.service.bgColor);this.service.topText.updateStyle("stroke",this.service.accentColor);this.service.buttons.addClass("hidden");this.service.saveImageButton.element.onclick=function(e){return t.saveImageButtonClick(e)};this.service.tweetButton.element.onclick=function(e){return t.tweetButtonClick(e)};this.service.resetButton.element.onclick=function(e){return t.resetButtonClick(e)};this.service.world.element.onclick=function(){return t.nextStep()};this.service.world.element.onkeyup=function(){return t.nextStep()}};t.prototype.animate=function(t){var e=function(r){var n=r.origin,o=r.x,i=r.y,a=r.scale,s=r.rotate;var u=50+Math.abs(n-5);var l=(5+Math.abs(a-50))/10;var c=64-Math.abs(128-o);var h=64-Math.abs(128-i);t.updateStyle("transform","translate("+c+"px, "+h+"px) scale("+l+") rotate("+s+"deg)");t.updateStyle("transform-origin",u+"px 40px");n=(n+1)%10;o=(o+7)%256;i=(i+3)%256;a=(a+1)%100;s=(s+9)%360;if(t.animation){requestAnimationFrame((function(){return e({origin:n,x:o,y:i,scale:a,rotate:s})}))}};t.animation=true;e({origin:random(10),x:random(256),y:random(256),scale:random(100),rotate:random(360)})};return t}();addEventListener("load",(function(t){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Service]}))}))}));var svg2png=function(t){var e,r,n,o;var i=t.cloneNode(false);var a=[[t,i]];while(a.length!==0){var s=__read(a.pop()||[],2),u=s[0],l=s[1];var c=window.getComputedStyle(u,"");var h=u.children;try{for(var f=(e=void 0,__values(c)),p=f.next();!p.done;p=f.next()){var d=p.value;l.style[d]=c.getPropertyValue(d)}}catch(t){e={error:t}}finally{try{if(p&&!p.done&&(r=f.return))r.call(f)}finally{if(e)throw e.error}}if(h.length!==0){try{for(var v=(n=void 0,__values(h)),y=v.next();!y.done;y=v.next()){var m=y.value;var g=m.cloneNode(false);l.appendChild(g);a.push([m,g])}}catch(t){n={error:t}}finally{try{if(y&&!y.done&&(o=v.return))o.call(v)}finally{if(n)throw n.error}}}else{l.innerHTML=u.innerHTML}}var b=(new XMLSerializer).serializeToString(i);var w={width:t.width.baseVal.value,height:t.height.baseVal.value};var _=Object.assign(document.createElement("canvas"),w);var E=_.getContext("2d");var x=new Image;return new Promise((function(t,e){x.onload=function(){E===null||E===void 0?void 0:E.drawImage(x,0,0);t(_.toDataURL("image/png"))};x.onerror=function(t){return e(t)};x.src="data:image/svg+xml;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(b)))}))};