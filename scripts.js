const random=(t=100)=>Math.round(Math.random()*t),average=t=>t.reduce((t,e)=>t+e,0)/t.length,median=t=>{const e=t.length/2|0,n=t.slice().sort((t,e)=>t<e?-1:e<t?1:0);return n.length%2?n[e]:(n[e-1]+n[e])/2},now=()=>(new Date).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"numeric"}).replace(/\D/g,""),QUERY_NAME_MAP={".body":"身体―― Body",".nose":"鼻―― Nose",".fang .left":"左のキバ―― Left Fang",".fang .right":"右のキバ―― Right Fang",".eye .left":"左目―― Left Eye",".eye .right":"右目―― Right Eye"};class Entity{static RESTORABLE_ATTRIBUTES=["stroke","transform","transform-origin"];uniqQuery;name;element;animation=!1;get searchParams(){const t=new URLSearchParams;return Entity.RESTORABLE_ATTRIBUTES.map(t=>[t,this.element.style.getPropertyValue(t)]).forEach(([e,n])=>n&&t.append(`${this.uniqQuery}:${e}`,n)),t}get value(){const t=t=>(t||"").split(/[^0-9^\\.]/).filter(Boolean).map(Number),[e,n,i,s]=t(this.element.style.getPropertyValue("transform")),[r,o]=t(this.element.style.getPropertyValue("transform-origin"));return{x:e,y:n,scale:i,rotate:s,originX:r,originY:o}}constructor(t){this.uniqQuery=t,this.name=QUERY_NAME_MAP[t]||"",this.element=document.querySelector(t)}removeClass(...t){this.element.classList.remove(t)}addClass(...t){this.element.classList.add(t)}updateStyle(t,e){this.element.style.setProperty(t,e)}reset(){this.updateStyle("transform","translate(0px, 0px) scale(1) rotate(0deg)"),this.updateStyle("transform-origin","50px 40px")}restore(){const t=Object.fromEntries(new URLSearchParams(location.search));Entity.RESTORABLE_ATTRIBUTES.forEach(e=>{const n=t[`${this.uniqQuery}:${e}`];n&&this.updateStyle(e,n),location.search.includes("%2C")||this.element.setAttribute(e,n)})}}class Service{hue=random();world=new Entity(".world");topText=new Entity(".top .text");buttons=new Entity(".buttons");saveImageButton=new Entity(".bottom .left.button");tweetButton=new Entity(".bottom .center.button");resetButton=new Entity(".bottom .right.button");animEntities=Object.keys(QUERY_NAME_MAP).map(t=>new Entity(t));params=new URLSearchParams(location.href);get bgColor(){return`hsl(${this.hue}, 100%, 70%)`}get accentColor(){return`hsl(${(this.hue-90)%360}, 100%, 40%)`}get resultURL(){const t=new URLSearchParams;return this.animEntities.forEach(e=>[...e.searchParams].forEach(([e,n])=>t.append(e,n))),t.append("hue",this.hue),`${location.href.replace(/(?!.*\/).*/,"")}?${t}`}get score(){const t=this.animEntities.reduce((t,{value:e})=>({x:[...t.x,e.x],y:[...t.y,e.y],scale:[...t.scale,e.scale],rotate:[...t.rotate,e.rotate],originX:[...t.originX,e.originX]}),{x:[],y:[],scale:[],rotate:[],originX:[]}),e=(t,e,n)=>average(t.map(i=>((t,e,n,i,s=!1)=>{const r=e-t;return 100-Math.abs(n-i%e*(s?2:1))/r*100})(e,n,median(t),i))),n=[e(t.x,-64,64),e(t.y,-64,64),e(t.scale,.5,5.5),e(t.rotate,0,180),e(t.originX,45,55)];return Math.round(10*average(n))/10}constructor(){new Control(this),null!=this.params.get("hue")&&this.restore(),null!=this.params.get("download")&&this.downloadImage()}downloadImage(){this.restore(),this.buttons.addClass("hidden"),svg2png(this.world.element).then(t=>{Object.assign(document.createElement("a"),{href:t,download:`akaino-warai_${(new Date).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"numeric"}).replace(/\D/g,"")}.png`}).click(),close()})}openDownloadWindow(){open(this.resultURL+"&download=")}tweet(){const t=encodeURIComponent(this.resultURL),e=this.score,n=encodeURIComponent(`${e}点！ ${e<6?"キミは伝説の低級戦士……":e<30?"もうなんだかよくわからない！":e<50?"こんな朱猪になっちゃった！":e<70?"まあまあの出来！":e<90?"イイ線いってる！":e<95?"ミラクルショット！あと一歩！":"こんな完璧な朱猪ってある？？？"} 朱猪わらいで朱猪を完成させよう！`),i=encodeURIComponent("朱猪わらい");open(`//twitter.com/intent/tweet?text=${n}&url=${t}&hashtags=${i}`,"_blank","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width=710,height=400")}reset(){this.hue=random(360),this.animEntities.forEach(t=>t.reset()),new Control(this)}restore(){this.hue=this.params.get("hue"),this.animEntities.forEach(t=>t.restore()),this.world.element.style.setProperty("background-color",this.bgColor),this.topText.updateStyle("stroke",this.accentColor),this.finish(),this.updateTopText()}finish(){this.world.element.onclick=this.world.element.onkeyup=null,this.world.addClass("loading"),setTimeout(()=>{this.buttons.removeClass("hidden"),this.updateTopText("Score: "+this.score)},500)}updateTopText(t=""){this.topText.element.innerHTML=t}}class Control{currentEntity=null;service;constructor(t){this.service=t,this.start()}saveImageButtonClick(t){t.stopPropagation(),this.service.openDownloadWindow()}tweetButtonClick(t){t.stopPropagation(),this.service.tweet()}resetButtonClick(t){t.stopPropagation(),this.service.reset()}nextStep(){null==this.currentEntity?(this.service.animEntities.forEach(t=>this.animate(t)),this.currentEntity=this.service.animEntities[0]):(this.currentEntity.updateStyle("stroke",null),this.currentEntity.animation=!1,this.currentEntity=this.service.animEntities[this.service.animEntities.indexOf(this.currentEntity)+1]),this.currentEntity?(this.service.updateTopText(this.currentEntity.name),this.currentEntity.updateStyle("stroke",this.service.accentColor)):this.service.finish()}start(){this.service.world.element.focus(),this.service.world.removeClass("loading"),this.service.updateTopText("クリックすると始まるよ！―― Click to Start!"),this.service.world.element.style.setProperty("background-color",this.service.bgColor),this.service.topText.updateStyle("stroke",this.service.accentColor),this.service.buttons.addClass("hidden"),this.service.saveImageButton.element.onclick=t=>this.saveImageButtonClick(t),this.service.tweetButton.element.onclick=t=>this.tweetButtonClick(t),this.service.resetButton.element.onclick=t=>this.resetButtonClick(t),this.service.world.element.onclick=()=>this.nextStep(),this.service.world.element.onkeyup=()=>this.nextStep()}animate(t){const e=({origin:n,x:i,y:s,scale:r,rotate:o})=>{const a=50+Math.abs(n-5),l=(5+Math.abs(r-50))/10,c=64-Math.abs(128-i),h=64-Math.abs(128-s);t.updateStyle("transform",`translate(${c}px, ${h}px) scale(${l}) rotate(${o}deg)`),t.updateStyle("transform-origin",a+"px 40px"),n=(n+1)%10,i=(i+7)%256,s=(s+3)%256,r=(r+1)%100,o=(o+9)%360,t.animation&&requestAnimationFrame(()=>e({origin:n,x:i,y:s,scale:r,rotate:o}))};t.animation=!0,e({origin:random(10),x:random(256),y:random(256),scale:random(100),rotate:random(360)})}}addEventListener("load",async t=>new Service);const svg2png=t=>{const e=t.cloneNode(!1),n=[[t,e]];for(e.version=1.1,e.xmlns="http://www.w3.org/2000/svg";0!==n.length;){const[t,e]=n.pop(),i=window.getComputedStyle(t,""),s=t.children;for(let t of i)e.style[t]=i.getPropertyValue(t);if(0!==s.length)for(let t of s){const i=t.cloneNode(!1);e.appendChild(i),n.push([t,i])}else e.innerHTML=t.innerHTML}const i=(new XMLSerializer).serializeToString(e),s={width:t.width.baseVal.value,height:t.height.baseVal.value},r=Object.assign(document.createElement("canvas"),s),o=r.getContext("2d"),a=new Image;return new Promise((t,e)=>{a.onload=()=>{o.drawImage(a,0,0),t(r.toDataURL("image/png"))},a.onerror=t=>e(t),a.src="data:image/svg+xml;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(i)))})};